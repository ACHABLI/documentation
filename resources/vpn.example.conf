# vpn-server-api
Listen 10.42.101.100:8008

<VirtualHost 10.42.101.100:8008>
    ServerName http://vpn.example:8008
    UseCanonicalName on

    ErrorLog logs/vpn.example_error_log
    TransferLog logs/vpn.example_access_log
    LogLevel warn

    SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1

    DocumentRoot /usr/share/vpn-server-api/web

    #<Proxy "fcgi://localhost" enablereuse=on max=10>
    <Proxy "fcgi://localhost" max=10>
    </Proxy>

    <Directory /usr/share/vpn-server-api/web>
        AllowOverride none
        <RequireAny>
            Require local
            Require ip 10.42.0.0/16
        </RequireAny>

        <Files "api.php">
            SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"
        </Files>
    </Directory>
</VirtualHost>

<VirtualHost *:80>
    ServerName http://vpn.example:80
    UseCanonicalName on

    ErrorLog logs/vpn.example_error_log
    TransferLog logs/vpn.example_access_log
    LogLevel warn

    Redirect permanent / https://vpn.example/
</VirtualHost>

<VirtualHost *:443>
    ServerName https://vpn.example:443
    UseCanonicalName on

    DocumentRoot /var/www/vpn.example

    ErrorLog logs/vpn.example_ssl_error_log
    # Do not log (valid) web browser requests
    #TransferLog logs/vpn.example_ssl_access_log
    LogLevel warn

    SSLEngine on
    SSLCertificateFile /etc/pki/tls/certs/vpn.example.crt
    SSLCertificateKeyFile /etc/pki/tls/private/vpn.example.key
    #SSLCertificateChainFile /etc/pki/tls/certs/vpn.example-chain.crt

    # Let's Encrypt
    #SSLCertificateFile /etc/letsencrypt/live/vpn.example/cert.pem
    #SSLCertificateKeyFile /etc/letsencrypt/live/vpn.example/privkey.pem
    #SSLCertificateChainFile /etc/letsencrypt/live/vpn.example/chain.pem

    # Security Headers
    # https://securityheaders.io/
    Header always set Content-Security-Policy "default-src 'self'"
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "same-origin"
    Header always set Strict-Transport-Security "max-age=15768000"

    SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1

    # Redirect requests to the portal (302)
    RewriteEngine on
    RewriteRule   "^/$"  "/portal/"  [R]

    #<Proxy "fcgi://localhost" enablereuse=on max=10>
    <Proxy "fcgi://localhost" max=10>
    </Proxy>

    # vpn-user-portal
    Alias /portal /usr/share/vpn-user-portal/web
    <Directory /usr/share/vpn-user-portal/web>
        AllowOverride none
        Require all granted

        DirectoryIndex index.php

        RewriteEngine on
        RewriteBase /portal
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^ index.php [L,QSA]

        <Files "index.php">
            SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"
        </Files>
        <Files "api.php">
            SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"
        </Files>
        <Files "oauth.php">
            SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"
        </Files>
    </Directory>

    # vpn-admin-portal
    Alias /admin /usr/share/vpn-admin-portal/web
    <Directory /usr/share/vpn-admin-portal/web>
        AllowOverride none
        Require all granted

        DirectoryIndex index.php

        RewriteEngine on
        RewriteBase /admin
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^ index.php [L,QSA]

        <Files "index.php">
            SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"
        </Files>
    </Directory>

    ## SAML/Mellon Authentication
    #<Location />
    #    MellonEnable "info"
    #    MellonSecureCookie On
    #    MellonIdP "IDP"
    #    MellonMergeEnvVars On
    #    MellonSPPrivateKeyFile /etc/httpd/saml/https_vpn.example_saml.key
    #    MellonSPCertFile /etc/httpd/saml/https_vpn.example_saml.cert
    #    MellonSPMetadataFile /etc/httpd/saml/https_vpn.example_saml.xml
    #    MellonEndpointPath /saml
    #    # When using SURFconext as a WAYF, use this line
    #    MellonIdPMetadataFile /etc/httpd/saml/SURFconext.xml
    #    # When using php-saml-ds, use these two lines below 
    #    # MellonIdPMetadataFile /var/lib/php-saml-ds/https_vpn.example_saml.xml
    #    # MellonDiscoveryUrl "https://disco.eduvpn.nl/wayf/index.php"
    #</Location>
    #
    #<Location /portal>
    #    MellonEnable "auth"
    #</Location>
    #
    ## disable Mellon for the API
    #<Location /portal/api.php>
    #    MellonEnable "off"
    #</Location>
    #<Location /portal/oauth.php>
    #    MellonEnable "off"
    #</Location>
    #
    #<Location /admin>
    #    MellonEnable "auth"
    #</Location>
</VirtualHost>
