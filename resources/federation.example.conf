<VirtualHost *:80>
    ServerName http://federation.example:80
    UseCanonicalName on

    ErrorLog logs/federation.example_error_log
    TransferLog logs/federation.example_access_log
    LogLevel warn

    Redirect permanent / https://federation.example/
</VirtualHost>

<VirtualHost *:443>
    ServerName https://federation.example:443
    UseCanonicalName on

    DocumentRoot /var/www/federation.example

    ErrorLog logs/federation.example_ssl_error_log
    # Do not log (valid) web browser requests
    #TransferLog logs/federation.example_ssl_access_log
    LogLevel warn

    SSLEngine on
    SSLCertificateFile /etc/pki/tls/certs/federation.example.crt
    SSLCertificateKeyFile /etc/pki/tls/private/federation.example.key
    #SSLCertificateChainFile /etc/pki/tls/certs/federation.example-chain.crt

    # Let's Encrypt
    #SSLCertificateFile /etc/letsencrypt/live/federation.example/cert.pem
    #SSLCertificateKeyFile /etc/letsencrypt/live/federation.example/privkey.pem
    #SSLCertificateChainFile /etc/letsencrypt/live/federation.example/chain.pem

    # Redirect requests to the federated client (302)
    RewriteEngine on
    RewriteRule   "^/$"  "/vpn-api-client/"  [R]

    #<Proxy "fcgi://localhost" enablereuse=on max=10>
    <Proxy "fcgi://localhost" max=10>
    </Proxy>

    Alias /vpn-token-service /usr/share/vpn-token-service/web
    <Directory /usr/share/vpn-token-service/web>
        AllowOverride None
        Require all granted

        <Files authorize.php>
            # Security Headers
            # https://securityheaders.io/
            Header always set Content-Security-Policy "default-src 'self'"
            Header always set X-Frame-Options "DENY"
            Header always set X-Content-Type-Options "nosniff"
            Header always set X-XSS-Protection "1; mode=block"
            Header always set Referrer-Policy "same-origin"
            Header always set Strict-Transport-Security "max-age=15768000"
        </Files>

        # if mod_php is not installed, assume php-fpm
        <IfModule !mod_php5.c>
            <IfModule !mod_php7.c>
                <Files "authorize.php">
                    SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"
                </Files>
                <Files "token.php">
                    SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"
                </Files>
            </IfModule>
        </IfModule>
    </Directory>

    Alias /vpn-api-client /usr/share/vpn-api-client/web
    <Directory /usr/share/vpn-api-client/web>
        AllowOverride None
        Require all granted
        DirectoryIndex index.php

        # Security Headers
        # https://securityheaders.io/
        Header always set Content-Security-Policy "default-src 'self'"
        Header always set X-Frame-Options "DENY"
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "same-origin"
        Header always set Strict-Transport-Security "max-age=15768000"

        # if mod_php is not installed, assume php-fpm
        <IfModule !mod_php5.c>
            <IfModule !mod_php7.c>
                <Files "index.php">
                    SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"
                </Files>
                <Files "callback.php">
                    SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"
                </Files>
            </IfModule>
        </IfModule>
    </Directory>

    Alias /php-saml-ds /usr/share/php-saml-ds/web
    <Directory /usr/share/php-saml-ds/web>
        AllowOverride None
        Require all granted
        DirectoryIndex index.php

        # Security Headers
        # https://securityheaders.io/
        Header always set Content-Security-Policy "default-src 'self'"
        Header always set X-Frame-Options "DENY"
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "same-origin"
        Header always set Strict-Transport-Security "max-age=15768000"

        # if mod_php is not installed, assume php-fpm
        <IfModule !mod_php5.c>
            <IfModule !mod_php7.c>
                <Files "index.php">
                    SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"
                </Files>
            </IfModule>
        </IfModule>
    </Directory>

    ## SAML/Mellon Authentication
    #<Location />
    #    MellonEnable "info"
    #    MellonSecureCookie On
    #    MellonIdP "IDP"
    #    MellonSPPrivateKeyFile /etc/httpd/saml/https_federation.example_saml.key
    #    MellonSPCertFile /etc/httpd/saml/https_federation.example_saml.cert
    #    MellonSPMetadataFile /etc/httpd/saml/https_federation.example_saml.xml
    #    MellonIdPMetadataFile /var/lib/php-saml-ds/metadata.xml
    #    MellonEndpointPath /saml
    #    MellonDiscoveryUrl "https://federation.example/php-saml-ds/index.php"

    #</Location>
    #
    #<Location /vpn-token-service>
    #    MellonEnable "auth"
    #</Location>
</VirtualHost>
