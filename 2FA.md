# Two-factor Authentication

The software supports two-factor authentication (2FA) for both authenticating
at the user/admin portal and for connecting to the VPN.

Currently both [YubiKey](https://yubico.com/) and 
[TOTP](https://en.wikipedia.org/wiki/Time-based_One-time_Password_Algorithm) 
are supported.

By default, 2FA will only be used for authenticating to the user and admin
portals, and not for connecting to the VPN.

## Enrollment

Users can enroll themselves in the portal on the "Account" page. If the user
is enrolled for 2FA, and has access to the admin portal, it will also be used
there.

The documentation page in the user portal gives more information about 2FA and
how to use it.

**NOTE**: currently a user can enroll for both YubiKey and TOTP 2FA. The 2FA 
method can be "upgraded" to YubiKey at any time, which may be a security risk,
see this [issue](https://github.com/eduvpn/vpn-user-portal/issues/60).

## Enabling 2FA for VPN connections

Assuming your profile is `internet`, you need to modify 
`/etc/vpn-server-api/default/config.php`:

    'vpnProfiles' => [
        'internet' => [
            'profileNumber' => 1,
            'displayName' => 'Internet Access',
            ...
            ...
            'twoFactor' => true,
        ],
    ],

Now the OpenVPN server configuration files need to be regenerated:

    $ sudo vpn-server-node-server-config

Also, the VPN processes need to be restarted:

    $ sudo systemctl restart "openvpn-server@default-*"

## Connecting to the VPN

Users will need to provide their OTP key also when authenticating to the
VPN. The client will ask for a user name and password. The user name MUST be
`totp` and as password the 6 digit code generated by the OTP application, or
`yubi` and the code generated by the YubiKey when pressing its button.

When 2FA is enabled, after 8 hours the user will be required to provide a new 
OTP code.

For example on Windows:

![OTP on Windows](img/windows_otp.png)

## Recovery

If a user lost their second factor credentials, they can be removed through 
the "admin".

If an administrator is enrolled for OTP, is the only administrator and loses 
their secret, the enrollment can be cancelled removing the OTP enrollment in
the DB. Assuming the user ID is `foo`, do the following:

    $ sudo sqlite3 /var/lib/vpn-server-api/default/db.sqlite

Perform the following query:

    UPDATE users SET totp_secret=NULL, yubi_key_id=NULL WHERE user_id='foo'

## Plugin

An OpenVPN [plugin](https://github.com/fac/auth-script-openvpn) is available to 
handle 2FA on the side of OpenVPN in a better way. By default verifying the 
second factor will block the OpenVPN process, making it impossible for 
connected clients to send/receive traffic in the meantime. This is obviously 
bad for performance, especially if there are a lot of clients connecting to the 
VPN profile with 2FA enabled.

A [package](https://copr.fedorainfracloud.org/coprs/fkooman/openvpn/) is 
available (for CentOS and Fedora) that will install the OpenVPN plugin. This is 
currently not installed by default as there is no "official" release yet of 
this plugin.

After installing the plugin the OpenVPN server configuration files need to be 
regenerated, the script will detect if the plugin is installed and then use it:

    $ sudo vpn-server-node-server-config

Also, the VPN processes need to be restarted:

    $ sudo systemctl restart "openvpn-server@default-*"
