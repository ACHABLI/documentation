# Two-factor Authentication

The software supports two-factor authentication (2FA) for both authenticating
at the user/admin portal and for connecting to the VPN.

Currently both 
[TOTP](https://en.wikipedia.org/wiki/Time-based_One-time_Password_Algorithm) 
and [YubiKey](https://yubico.com/) are supported. However, YubiKey is 
DEPRECATED and no longer enabled by default on new server installations.

By default, 2FA will only be used for authenticating to the user and admin
portals, and not for connecting to the VPN.

## Enrollment

Users can enroll themselves in the portal on the "Account" page. If the user
is enrolled for 2FA, and has access to the admin portal, it will also be used
there.

The documentation page in the user portal gives more information about 2FA and
how to use it.

**NOTE**: currently a user can enroll for all enabled 2FA methods. The 2FA 
method can be "upgraded" to YubiKey at any time when YubiKey is enabled, which 
may be a security risk.

## Enabling 2FA for VPN connections

Assuming your profile is `internet`, you need to modify 
`/etc/vpn-server-api/default/config.php`:

    'vpnProfiles' => [
        'internet' => [
            'profileNumber' => 1,
            'displayName' => 'Internet Access',
            ...
            ...
            'twoFactor' => true,
        ],
    ],

Now the OpenVPN server configuration files need to be regenerated:

    $ sudo vpn-server-node-server-config

Also, the VPN processes need to be restarted:

    $ sudo systemctl restart "openvpn-server@default-*"

## Connecting to the VPN

Users will need to provide their OTP key also when authenticating to the
VPN. The client will ask for a user name and password. The user name MUST be
`totp` and as password the 6 digit code generated by the OTP application, or
`yubi` and the code generated by the YubiKey when pressing its button.

When 2FA is enabled, after 8 hours the user will be required to provide a new 
OTP code.

For example on Windows:

![OTP on Windows](img/windows_otp.png)

## Recovery

If a user lost their second factor credentials, 2FA can be removed through 
the "admin" for that user.

If an administrator is enrolled for OTP, is the only administrator and loses 
their secret, the enrollment can be cancelled removing the OTP enrollment in
the DB. Assuming the user ID is `foo`, do the following:

    $ sudo sqlite3 /var/lib/vpn-server-api/default/db.sqlite

Perform the following queries to remove the YubiKey ID and the OTP secret:

    UPDATE users SET yubi_key_id=NULL WHERE user_id='foo';
    DELETE FROM otp WHERE user_id='foo';

## Plugin

**NOTE**: this plugin is EXPERIMENTAL! It did not receive extensive testing!

An OpenVPN [plugin](https://github.com/fkooman/auth-script-openvpn) is 
available to handle 2FA on the side of OpenVPN in a better way. By default,
verifying the second factor will block the OpenVPN process, making it 
impossible for other connected clients to send/receive traffic in the meantime. 
This is obviously bad for performance, especially if there are a lot of clients 
connecting to the VPN profile with 2FA enabled.

Packages are available for Debian and CentOS/Red Hat Enterprise Linux/Fedora.

### Debian

    $ sudo apt-get install openvpn-auth-script

### CentOS/Red Hat Enterprise Linux

    $ sudo yum -y install openvpn-plugin-auth-script

### Fedora

    $ sudo dnf -y install openvpn-plugin-auth-script

After installing the plugin the OpenVPN server configuration files need to be 
regenerated, the script will detect if the plugin is installed and then use it:

    $ sudo vpn-server-node-server-config

Also, the VPN processes need to be restarted:

    $ sudo systemctl restart "openvpn-server@default-*"
